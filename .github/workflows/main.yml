name: Kernel_Builder

on:
  workflow_dispatch:
    inputs:
      user:
        description: "ğŸ‘¨â€ğŸ’» Repository_Owner"
        required: true
        default: "sa9990"
        type: string
      repo:
        description: "ğŸ  Repository"
        required: true
        default: "Source"
        type: string
      branch:
        description: "âš™ï¸ Branch"
        required: true
        default: "y_ksu"
        type: string
      clang_type:
        description: "ğŸ› ï¸ Clang_Type (aosp or neutron)"
        required: true
        default: "neutron"
        type: choice
        options:
          - aosp
          - neutron
      clang_url:
        description: "ğŸ”— AOSP Clang URL (if using aosp)"
        required: false
        default: ""
        type: string
      config:
        description: "ğŸ“„ Device_Defconfig"
        required: true
        default: "vendor/obiwan_defconfig"
        type: string
      ksu:
        description: "âš ï¸ Integrate KernelSU"
        required: false
        default: false
        type: choice
        options:
          - "true"
          - "false"
      LocalVersion:
        description: "ğŸ“„ Set custom localversion"
        required: false
        type: string
      cmd:
        description: "ğŸ“œ Extra_Make_cmd"
        required: false
        default: "-s"
        type: string
      import:
        description: "Import configs into defconfig"
        required: false
        default: ""
        type: string

env:
  TZ: Asia/Kolkata
  GITHUB_TOKEN: ${{ secrets.GH_PAT }}
  DEVICE: Obiwan

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: Install Build Dependencies
        run: |
          echo "ğŸ”§ Installing dependencies..."
          sudo apt update > /dev/null 2>&1
          sudo apt update -qq && sudo apt install -y git build-essential bc bison flex lzop zip unzip curl libssl-dev zlib1g-dev liblz4-tool device-tree-compiler python3

      - name: Clone Kernel Source (with submodules)
        env:
           GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
           git clone -b ${{ inputs.branch }} \
           https://${{ inputs.user }}:${GITHUB_TOKEN}@github.com/${{ inputs.user }}/${{ inputs.repo }}.git --depth=1
           cd ${{ inputs.repo }}
           git submodule init
           git submodule update
           git submodule status

      - name: Set up Toolchain
        run: |
          echo "ğŸ§° Setting up toolchain..."
          TOOLCHAIN_DIR="$HOME/toolchains"
          mkdir -p "$TOOLCHAIN_DIR"

          if [[ "${{ inputs.clang_type }}" == "aosp" ]]; then
            echo "Using AOSP Clang"
            mkdir -p "$TOOLCHAIN_DIR/aosp-clang"
            cd "$TOOLCHAIN_DIR/aosp-clang"
            curl -L -s "${{ inputs.clang_url }}" -o clang.tar.gz && echo "âœ… AOSP Clang downloaded"
            tar -xzf clang.tar.gz && echo "âœ… AOSP Clang extracted"
            echo "TOOLCHAIN_PATH=$TOOLCHAIN_DIR/aosp-clang/bin" >> $GITHUB_ENV
            echo "TOOLCHAIN_NAME=AOSP" >> $GITHUB_ENV
          else
            echo "Using Neutron Clang"
            mkdir -p "$TOOLCHAIN_DIR/neutron-clang"
            cd "$TOOLCHAIN_DIR/neutron-clang"
            curl -LO "https://raw.githubusercontent.com/Neutron-Toolchains/antman/main/antman" && echo "âœ… antman downloaded"
            chmod +x antman
            ./antman -S && echo "âœ… Neutron toolchain"
            echo "TOOLCHAIN_PATH=$TOOLCHAIN_DIR/neutron-clang/bin" >> $GITHUB_ENV
            echo "TOOLCHAIN_NAME=Neutron" >> $GITHUB_ENV
          fi

      - name: Set localversion into kernel config
        working-directory: ${{ inputs.repo }}
        run: |
          echo "ğŸ”§ Setting localversion..."
          if [[ ! -z "${{ inputs.LocalVersion }}" ]]; then
            sed -i '\#CONFIG_LOCALVERSION#d' arch/arm64/configs/${{ inputs.config }} && echo "âœ… Removed old CONFIG_LOCALVERSION"
            echo >> arch/arm64/configs/${{ inputs.config }}
            echo 'CONFIG_LOCALVERSION_AUTO=n' >> arch/arm64/configs/${{ inputs.config }}
            echo 'CONFIG_LOCALVERSION="${{ inputs.LocalVersion }}"' >> arch/arm64/configs/${{ inputs.config }} && echo "âœ… Set new localversion"
          else
            sed -i '\#CONFIG_LOCALVERSION#d' arch/arm64/configs/${{ inputs.config }}
            echo 'CONFIG_LOCALVERSION_AUTO=n' >> arch/arm64/configs/${{ inputs.config }} && echo "âœ… Disabled localversion auto"
          fi

      - name: Integrate KernelSU
        working-directory: ${{ inputs.repo }}
        run: |
          if [[ "${{ inputs.ksu }}" == "true" ]]; then
            echo "ğŸ”§ Applying KernelSU integration..."
            wget -qO syscall_hook_patches.sh \
            https://raw.githubusercontent.com/SA9990/KernelSU_Patch/refs/heads/x/syscall_hook_patches.sh
            chmod +x syscall_hook_patches.sh
            bash syscall_hook_patches.sh
            rm -rf drivers/kernelsu && echo "âœ… Old KernelSU directory removed"
            git clone https://github.com/rsuntk/KernelSU.git && echo "âœ… KernelSU source cloned"
            mv KernelSU/kernel drivers/kernelsu && echo "âœ… Moved kernel source to drivers/kernelsu"
            cd KernelSU
            export KSU_GIT_VERSION=$(git rev-list --count HEAD) && echo "âœ… Fetched KernelSU version: $KSU_GIT_VERSION"
            echo "KSU=$((KSU_GIT_VERSION))" >> $GITHUB_ENV
            cd ..
            sed -i '33,57d' drivers/kernelsu/Makefile && echo "âœ… Cleaned old versioning lines"
            echo KSU_GIT_VERSION := $KSU_GIT_VERSION >> drivers/kernelsu/Makefile
            echo KSU_GIT_VERSION_VALID := 1 >> drivers/kernelsu/Makefile
            echo '$(eval KSU_VERSION=$(shell expr 20000 + $(KSU_GIT_VERSION)))' >> drivers/kernelsu/Makefile
            echo '$(info -- KernelSU version: $(KSU_VERSION))' >> drivers/kernelsu/Makefile
            echo 'ccflags-y += -DKSU_VERSION=$(KSU_VERSION)' >> drivers/kernelsu/Makefile
            sed -i '\#endmenu#d' drivers/Kconfig && echo "âœ… Modified Kconfig"
            echo >> drivers/Kconfig
            echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
            echo >> drivers/Kconfig
            echo 'endmenu' >> drivers/Kconfig
            echo 'obj-$(CONFIG_KSU) += kernelsu/' >> drivers/Makefile
            echo 'CONFIG_KSU=y' >> arch/arm64/configs/${{ inputs.config }} && echo "âœ… Enabled KSU in defconfig"
          fi

      - name: Import configs into defconfig
        working-directory: ${{ inputs.repo }}
        run: |
          echo '${{ inputs.import }}' >> arch/arm64/configs/${{ inputs.config }}

      - name: Configure and Build Kernel
        working-directory: ${{ inputs.repo }}
        run: |
          echo "ğŸ§± Building kernel..."
          export PATH="${{ env.TOOLCHAIN_PATH }}:$PATH"
          make distclean
          git submodule update --init --recursive
          git submodule status
          make -j$(nproc --all) O=out ARCH=arm64 CC=clang CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 ${{ inputs.cmd }} ${{ inputs.config }}
          make -j$(nproc --all) O=out ARCH=arm64 CC=clang CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 ${{ inputs.cmd }} all && echo "âœ… Kernel compiled"

      - name: Generate Defconfig
        working-directory: ${{ inputs.repo }}
        run: |
          mv out/.config out/${{ env.DEVICE }}.txt && echo "âœ… Saved defconfig"

      - name: Merge DTBs
        working-directory: ${{ inputs.repo }}
        run: |
          find out/arch/arm64/boot/dts/vendor -name '*.dtb' -exec cat {} + > out/arch/arm64/boot/dtb && echo "âœ… DTBs merged"

      - name: Set Build Timestamp
        run: |
          echo "IST_TIME=$(date +"%Y-%m-%d_%H-%M")" >> $GITHUB_ENV && echo "âœ… Timestamp set"

      - name: Package with AnyKernel3
        run: |
          echo "ğŸ“¦ Packaging with AnyKernel3..."
          export TZ=Asia/Kolkata
          IST_TIME=$(date +"%d-%m-%Y_%H-%M")
          ZIP_NAME="${IST_TIME}_${{ env.KSU }}.zip"
          echo "$ZIP_NAME" > zip_name.txt

          git clone https://github.com/SA9990/AK3_obiwan.git && echo "âœ… Cloned AnyKernel3"
          cp ${{ inputs.repo }}/out/arch/arm64/boot/Image AK3_obiwan/ && echo "âœ… Copied Image"
          cp ${{ inputs.repo }}/out/arch/arm64/boot/dtb AK3_obiwan/ && echo "âœ… Copied DTB"
          find ${{ inputs.repo }}/out/ -type f -name "*.ko" -exec cp {} AK3_obiwan/modules/system/lib/modules/ \; || true && echo "âœ… Copied modules"
          find ${{ inputs.repo }}/out/ -type f -name "dtbo.img" -exec cp {} AK3_obiwan/ \; || true
          cd AK3_obiwan
          zip -r9 "../$ZIP_NAME" * -x .git README.md *placeholder && echo "âœ… AnyKernel3 packaged"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.4.1
        with:
          tag_name: "${{ inputs.repo }}_${{ inputs.branch }}_${{ env.KSU }}"
          name: "${{ env.DEVICE }}_${{ env.IST_TIME }}"
          body: |
            - ğŸ—“ï¸ **Build Date:** `${{ env.IST_TIME }}`
            - ğŸ“± **Device:** `${{ env.DEVICE }}`
            - ğŸ‘¤ **Maintainer:** `${{ inputs.user }}`
            - ğŸ“ **Repo:** `${{ inputs.repo }}`
            - ğŸŒ¿ **Branch:** `${{ inputs.branch }}`
            - ğŸ› ï¸ **Toolchain:** `${{ env.TOOLCHAIN_NAME }}`
            - ğŸ§© **KernelSU:** `${{ env.KSU }}`
            - âš™ï¸ **Defconfig:** `${{ inputs.config }}`
          files: |
            ${{ github.workspace }}/*.zip
            ${{ github.workspace }}/${{ inputs.repo }}/out/${{ env.DEVICE }}.txt
